{"data":{"edges":[],"nodes":[{"data":{"node":{"template":{"_type":"Component","code":{"type":"code","required":true,"placeholder":"","list":false,"show":true,"multiline":true,"value":"import os\r\nimport psycopg2\r\nfrom urllib.parse import urlparse\r\nfrom langflow.base.io.chat import ChatComponent\r\nfrom langflow.inputs import MessageInput\r\nfrom langflow.io import Output\r\nfrom langflow.schema.message import Message\r\n\r\n# Componente criado por Pedro Collares Xavier\r\n\r\nclass InsertAvaliationFromMessageComponent(ChatComponent):\r\n    display_name = \"Insert Feedback com Avaliação\"\r\n    description = \"Insere a última mensagem na tabela feedback_descritivo usando o texto recebido como avaliação.\"\r\n    icon = \"Database\"\r\n\r\n    inputs = [\r\n        MessageInput(name=\"message\", display_name=\"Mensagem com Avaliação\", input_types=[\"Message\"]),\r\n    ]\r\n\r\n    outputs = [\r\n        Output(name=\"status\", display_name=\"Status\", output_types=[\"Message\"], method=\"message_response\")\r\n    ]\r\n\r\n    async def message_response(self) -> Message:\r\n        avaliacao = self.message.text.strip()\r\n        \r\n        # Se a avaliação estiver vazia, para o fluxo sem saída\r\n        if not avaliacao:\r\n            self.stop(\"status\")\r\n            return\r\n\r\n        try:\r\n            db_url = os.getenv(\"LANGFLOW_DATABASE_URL\")\r\n            if not db_url:\r\n                raise Exception(\"LANGFLOW_DATABASE_URL não está definida no ambiente.\")\r\n\r\n            parsed = urlparse(db_url)\r\n            conn = psycopg2.connect(\r\n                dbname=parsed.path[1:],\r\n                user=parsed.username,\r\n                password=parsed.password,\r\n                host=parsed.hostname,\r\n                port=parsed.port or 5432,\r\n            )\r\n\r\n            cursor = conn.cursor()\r\n\r\n            # Pega a última mensagem registrada\r\n            cursor.execute(\"\"\"\r\n                SELECT session_id, timestamp, sender, text\r\n                FROM message\r\n                ORDER BY timestamp DESC\r\n                LIMIT 1\r\n            \"\"\")\r\n            result = cursor.fetchone()\r\n\r\n            if not result:\r\n                raise Exception(\"Nenhuma mensagem encontrada na tabela 'message'.\")\r\n\r\n            session_id, timestamp, sender, text = result\r\n\r\n            # Insere na tabela feedback_descritivo com clasificador feedback e avaliacao razoavel\r\n            cursor.execute(\"\"\"\r\n                INSERT INTO feedback_descritivo (session_id, timestamp, sender, text, classificador, avaliacao)\r\n                VALUES (%s, %s, %s, %s, %s, %s)\r\n            \"\"\", (session_id, timestamp, sender, text, 'F', 'RZ'))\r\n\r\n            conn.commit()\r\n            cursor.close()\r\n            conn.close()\r\n\r\n            return Message(text=\"Obrigado pela sua avaliação! Posso ajudar com mais alguma questão relacionado a Solução CMFlex?\")\r\n\r\n        except Exception as e:\r\n            return Message(text=f\"❌ Erro ao inserir feedback: {e}\")\r\n","fileTypes":[],"file_path":"","password":false,"name":"code","advanced":true,"dynamic":true,"info":"","load_from_db":false,"title_case":false},"message":{"trace_as_input":true,"tool_mode":false,"trace_as_metadata":true,"load_from_db":false,"list":false,"list_add_label":"Add More","required":false,"placeholder":"","show":true,"name":"message","value":"","display_name":"Mensagem com Avaliação","advanced":false,"input_types":["Message"],"dynamic":false,"info":"","title_case":false,"type":"str","_input_type":"MessageInput"}},"description":"Insere a última mensagem na tabela feedback_descritivo usando o texto recebido como avaliação.","icon":"Database","base_classes":["Message"],"display_name":"Insert Feedback com Avaliação","documentation":"","minimized":false,"custom_fields":{},"output_types":[],"pinned":false,"conditional_paths":[],"frozen":false,"outputs":[{"types":["Message"],"selected":"Message","name":"status","hidden":null,"display_name":"Status","method":"message_response","value":"__UNDEFINED__","cache":true,"required_inputs":null,"allows_loop":false,"options":null,"tool_mode":true}],"field_order":["message"],"beta":false,"legacy":false,"edited":true,"metadata":{},"tool_mode":false,"official":false},"showNode":true,"type":"InsertAvaliationFromMessageComponent","id":"InsertAvaliationFromMessageComponent-MPE2V"},"id":"InsertAvaliationFromMessageComponent-MPE2V","position":{"x":0,"y":0},"type":"genericNode"}],"viewport":{"x":1,"y":1,"zoom":1}},"description":"Insere a última mensagem na tabela feedback_descritivo usando o texto recebido como avaliação.","name":"Insert Feedback com Avaliação","id":"InsertAvaliationFromMessageComponent-MPE2V","is_component":true,"last_tested_version":"1.4.3"}